<!DOCTYPE html>
<html>
<head>
  <title>Meds Reminder</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Meds Reminder</h2>

  <!-- Login/Register -->
  <div>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="register">Register</button>
    <button id="login">Login</button>
    <p id="status"></p>
  </div>

  <hr>

  <!-- Add Secondary User -->
  <div>
    <h3>Add Secondary User</h3>
    <input type="email" id="secondaryEmail" placeholder="Secondary user email">
    <input type="password" id="secondaryPass" placeholder="Password">
    <button id="addUserBtn">Add User</button>
    <ul id="userList"></ul>
  </div>

  <hr>

  <!-- Medication Manager -->
  <div>
    <h3>Medications</h3>
    <input type="text" id="medName" placeholder="Medication name">
    <input type="text" id="medDosage" placeholder="Dosage (e.g. 50mg)">
    <button id="addMedBtn">Add Medication</button>
    <ul id="medList"></ul>
  </div>

  <hr>

  <!-- Reminder Setup -->
  <div>
    <h3>Set Reminders</h3>
    <label>Reminders per day: <input type="number" id="reminderCount" min="1" value="1"></label>
    <div id="reminderInputs"></div>
    <button id="saveReminders">Save All Reminders</button>
  </div>

  <script type="module">
    import { auth } from './firebase-init.js';
    import {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    import { db } from './firebase-init.js';
    import {
      collection,
      addDoc,
      query,
      where,
      getDocs,
      setDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const status = document.getElementById('status');
    const secEmail = document.getElementById('secondaryEmail');
    const secPass = document.getElementById('secondaryPass');
    const userList = document.getElementById('userList');
    const medName = document.getElementById('medName');
    const medDosage = document.getElementById('medDosage');
    const medList = document.getElementById('medList');
    const reminderCount = document.getElementById('reminderCount');
    const reminderInputs = document.getElementById('reminderInputs');

    let selectedUserDocId = null;
    let medications = [];

    document.getElementById('register').onclick = async () => {
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email.value, password.value);
        status.textContent = `✅ Registered: ${userCred.user.email}`;
      } catch (e) {
        status.textContent = `❌ ${e.message}`;
      }
    };

    document.getElementById('login').onclick = async () => {
      try {
        const userCred = await signInWithEmailAndPassword(auth, email.value, password.value);
        status.textContent = `✅ Logged in: ${userCred.user.email}`;
        loadUsers();
      } catch (e) {
        status.textContent = `❌ ${e.message}`;
      }
    };

    document.getElementById('addUserBtn').onclick = async () => {
      if (!auth.currentUser) return alert("Please log in first");

      const userData = {
        caregiver: auth.currentUser.email,
        email: secEmail.value,
        password: secPass.value
      };

      const docRef = await addDoc(collection(db, "secondaryUsers"), userData);
      alert("Secondary user added!");
      secEmail.value = '';
      secPass.value = '';
      loadUsers();
    };

    async function loadUsers() {
      userList.innerHTML = "";

      const q = query(collection(db, "secondaryUsers"), where("caregiver", "==", auth.currentUser.email));
      const results = await getDocs(q);
      results.forEach(docSnap => {
        const li = document.createElement('li');
        li.textContent = docSnap.data().email;
        li.onclick = () => {
          selectedUserDocId = docSnap.id;
          alert(`Selected ${docSnap.data().email}`);
        };
        userList.appendChild(li);
      });
    }

    document.getElementById('addMedBtn').onclick = () => {
      const name = medName.value.trim();
      const dose = medDosage.value.trim();
      if (name && dose) {
        medications.push(`${name} ${dose}`);
        const li = document.createElement('li');
        li.textContent = `${name} ${dose}`;
        medList.appendChild(li);
        medName.value = '';
        medDosage.value = '';
      }
    };

    reminderCount.oninput = () => {
      reminderInputs.innerHTML = '';
      const count = parseInt(reminderCount.value);
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.innerHTML = `
          <label>Reminder ${i + 1} Time: <input type="time" id="time-${i}"></label><br>
          <label>Medications (comma separated): <input type="text" id="meds-${i}"></label>
          <hr>
        `;
        reminderInputs.appendChild(div);
      }
    };

    document.getElementById('saveReminders').onclick = async () => {
      if (!selectedUserDocId) return alert("Select a secondary user first.");

      const count = parseInt(reminderCount.value);
      for (let i = 0; i < count; i++) {
        const time = document.getElementById(`time-${i}`).value;
        const medsRaw = document.getElementById(`meds-${i}`).value;
        const meds = medsRaw.split(',').map(m => m.trim()).filter(m => m);
        if (time && meds.length > 0) {
          const reminderId = time.replace(":", "-");
          await setDoc(doc(db, "secondaryUsers", selectedUserDocId, "reminders", reminderId), {
            time,
            medications: meds
          });
        }
      }
      alert("Reminders saved!");
    };

    auth.onAuthStateChanged(user => {
      if (user) loadUsers();
    });
  </script>
</body>
</html>
