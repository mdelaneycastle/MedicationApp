<!DOCTYPE html>
<html>
<head>
  <title>Meds Reminder</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Meds Reminder</h2>

  <!-- Login/Register -->
  <div>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="register">Register</button>
    <button id="login">Login</button>
    <p id="status"></p>
  </div>

  <hr>

  <!-- Add Secondary User -->
  <div>
    <h3>Add Secondary User</h3>
    <input type="email" id="secondaryEmail" placeholder="Secondary user email">
    <input type="password" id="secondaryPass" placeholder="Password">
    <button id="addUserBtn">Add User</button>
    <ul id="userList"></ul>
  </div>

  <hr>

  <!-- Add below your existing HTML -->
<hr>
<h3>Add Medications</h3>
<input type="text" id="medName" placeholder="Medication name">
<input type="text" id="medDose" placeholder="Dose (e.g., 200mg)">
<button id="addMedBtn">Add Medication</button>
<ul id="medList"></ul>

<hr>
<h3>Set Reminders</h3>
<label>Number of reminders per day:</label>
<input type="number" id="numReminders" min="1" max="10">
<button id="generateRemindersBtn">Generate Fields</button>
<div id="reminderFields"></div>
<button id="saveRemindersBtn">Save Reminders</button>

<script type="module">
  const medName = document.getElementById('medName');
  const medDose = document.getElementById('medDose');
  const medList = document.getElementById('medList');
  const addMedBtn = document.getElementById('addMedBtn');

  const numRemindersInput = document.getElementById('numReminders');
  const generateBtn = document.getElementById('generateRemindersBtn');
  const reminderFields = document.getElementById('reminderFields');
  const saveRemindersBtn = document.getElementById('saveRemindersBtn');

  let secondaryUserId = null;
  let meds = [];

  async function getSecondaryUserIdByEmail(email) {
    const q = query(collection(db, "secondaryUsers"), where("email", "==", email));
    const snapshot = await getDocs(q);
    return snapshot.docs.length ? snapshot.docs[0].id : null;
  }

  addMedBtn.onclick = () => {
    const entry = `${medName.value} ${medDose.value}`;
    meds.push(entry);
    const li = document.createElement('li');
    li.textContent = entry;
    medList.appendChild(li);
    medName.value = '';
    medDose.value = '';
  };

  generateBtn.onclick = () => {
    reminderFields.innerHTML = '';
    const count = parseInt(numRemindersInput.value);
    for (let i = 0; i < count; i++) {
      const container = document.createElement('div');
      container.innerHTML = `
        <label>Reminder ${i + 1} time:</label>
        <input type="time" class="reminder-time">
        <br>
        <label>Select Medications:</label>
        ${meds.map((m, idx) => `
          <label><input type="checkbox" class="med-check" data-reminder="${i}" value="${m}"> ${m}</label>
        `).join('<br>')}
        <hr>
      `;
      reminderFields.appendChild(container);
    }
  };

  saveRemindersBtn.onclick = async () => {
    const email = prompt("Enter secondary user's email to save reminders to:");
    secondaryUserId = await getSecondaryUserIdByEmail(email);
    if (!secondaryUserId) return alert("User not found");

    const reminderDivs = reminderFields.querySelectorAll('div');
    for (const div of reminderDivs) {
      const timeInput = div.querySelector('.reminder-time');
      const time = timeInput.value;
      const selected = [...div.querySelectorAll('.med-check')].filter(cb => cb.checked).map(cb => cb.value);
      if (time && selected.length) {
        const reminderId = time.replace(':', '-');
        await setDoc(doc(db, "secondaryUsers", secondaryUserId, "reminders", reminderId), {
          time,
          medications: selected
        });
      }
    }
    alert("Reminders saved!");
  };
</script>
</body>
</html>
