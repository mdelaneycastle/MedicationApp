<!DOCTYPE html>
<html>
<head>
  <title>Carer Reminder Manager</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Meds Reminder Manager</h2>

  <div>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="login">Login</button>
    <p id="status"></p>
  </div>

  <hr>

  <div id="medicationsSection" style="display:none">
    <h3>Add Medication</h3>
    <input id="medName" placeholder="Medication name" />
    <input id="medDose" placeholder="Dose (e.g. 50mg)" />
    <button id="addMed">Add</button>
    <ul id="medList"></ul>
  </div>

  <div id="remindersSection" style="display:none">
    <h3>Create Reminders</h3>
    <label for="reminderCount">Reminders per day:</label>
    <input type="number" id="reminderCount" value="1" min="1" />
    <button id="generateReminders">Generate Inputs</button>

    <form id="reminderForm"></form>
    <button id="saveAllReminders">Save Reminders</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import {
      signInWithEmailAndPassword,
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      collection,
      setDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const medList = [];
    const medListEl = document.getElementById('medList');

    document.getElementById('login').onclick = async () => {
      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        await signInWithEmailAndPassword(auth, email, password);
        document.getElementById('status').textContent = `Logged in as ${email}`;
        document.getElementById('medicationsSection').style.display = 'block';
        document.getElementById('remindersSection').style.display = 'block';
      } catch (e) {
        document.getElementById('status').textContent = `âŒ ${e.message}`;
      }
    };

    document.getElementById('addMed').onclick = () => {
      const name = document.getElementById('medName').value;
      const dose = document.getElementById('medDose').value;
      if (name && dose) {
        medList.push(`${name} ${dose}`);
        const li = document.createElement('li');
        li.textContent = `${name} ${dose}`;
        medListEl.appendChild(li);
        document.getElementById('medName').value = '';
        document.getElementById('medDose').value = '';
      }
    };

    document.getElementById('generateReminders').onclick = () => {
      const count = parseInt(document.getElementById('reminderCount').value);
      const form = document.getElementById('reminderForm');
      form.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.innerHTML = `
          <label>Reminder ${i + 1} Time:</label>
          <input type="time" class="reminder-time" />
          <label>Medications:</label>
          <select multiple class="med-select">
            ${medList.map(med => `<option value="${med}">${med}</option>`).join('')}
          </select>
          <hr>
        `;
        form.appendChild(div);
      }
    };

    document.getElementById('saveAllReminders').onclick = async () => {
      const user = auth.currentUser;
      const reminderDivs = document.querySelectorAll('#reminderForm div');
      const uid = user.uid;

      for (const div of reminderDivs) {
        const time = div.querySelector('.reminder-time').value;
        const selected = [...div.querySelector('.med-select').selectedOptions].map(opt => opt.value);
        if (time && selected.length) {
          await setDoc(doc(db, 'secondaryUsers', uid, 'reminders', time.replace(':', '-')), {
            time,
            medications: selected
          });
        }
      }
      alert("Reminders saved!");
    };
  </script>
</body>
</html>
